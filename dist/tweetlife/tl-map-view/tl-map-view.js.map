{"version":3,"sources":["tweetlife/tl-map-view/tl-map-view.js"],"names":["d3","DAY_TIMESPAN","HOUR_TIMESPAN","DEBOUNC_TIME","TlMapView","Element","element","eventAggregator","CbkitDialogService","totalBrushTime","timelineStepTime","allowedPlay","allowHeatmap","showHeatmap","timelinePlayData","_debounceResize","debounce","_reRender","_attached","ea","cbkitDialogService","fetchSubscription","subscribe","timeline","resetTimeline","showPause","reseted","attached","mapContainer","select","svgContainer","linesContaner","_renderMap","loading","resizing","_init","detached","dispose","dataChanged","setTimeout","data","originTweet","attributes","country_code_enrich","timelineData","spreadMap","length","lastTimeDiff","key","lastHourDiff","Math","ceil","i","push","value","forEach","hour","tlData","mappingHour","find","d","_caculateBrushTime","_clearMap","_clearOriginLine","_clearSpreadLines","_renderOriginLine","self","idx","_renderHourLines","_renderHeatmap","$svgContainer","$","width","height","attr","features","filter","properties","name","projection","geo","mercator","oldScala","scale","oldTranslate","translate","xy","path","selectAll","enter","append","CountryCode","text","tweet","lineBaseTop","chart","echart","getChart","lineBaseLeft","convertToPixel","xAxisIndex","startPosition","originTweetGeo","_getTweetGeo","endPosition","line","svg","interpolate","x","y","_renderLocationPoint","r","class","index","endTime","animate","spreadTweets","time","Date","tw","event_time","eventTime","getTime","originTweetTime","location","_renderLine","twInfo","speadLine","_getSmoothPoint","id","duration","transition","attrTween","len","getTotalLength","t","interpolateString","each","position","options","assignIn","circle","datum","on","classed","currentEvent","currentEntity","entities","from","_showEntityCard","_hideEntityCard","openRecordDetail","countryCode","toUpperCase","spreadCountryPath","eventsByCountryCode","compute","rgb","scaleDomain","map","sortedUniq","colorRange","linear","domain","range","style","remove","cardContainer","offsetParent","parent","left","parseInt","css","top","min","removeClass","addClass","capitalInfo","cap","CapitalLongitude","CapitalLatitude","startPoint","endPoint","x1","y1","x2","y2","count","minTime","__toggleHeatmap","__playBtnClicked","playTimeline","__pauseBtnClicked","pauseTimeline","__resetBtnClicked","__timelineBrush","endItem","endIndex","__playDone","params"],"mappings":"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","file":"tl-map-view.js","sourceRoot":"/src","sourcesContent":["import { inject, customElement, bindable } from 'aurelia-framework';\nimport { EventAggregator } from 'aurelia-event-aggregator';\nimport { CbkitDialogService } from 'pg/cbkit';\nimport * as d3 from 'd3';\nimport _ from 'lodash';\nimport ResizeSensor from 'css-element-queries/src/ResizeSensor';\nimport worldMapData from './world-countries.json!';\nimport countryCapitalLocation from './countryCapitalLocation.json!';\n\n\nconst DAY_TIMESPAN = 24 * 60 * 60 * 1000;\nconst HOUR_TIMESPAN = 60 * 60 * 1000;\nconst DEBOUNC_TIME = 300;\n\n@customElement('tl-map-view')\n@inject(Element, EventAggregator, CbkitDialogService)\nexport class TlMapView {\n  @bindable data;\n  @bindable loading;\n  @bindable defaultView;\n  element;\n  ea;\n  cbkitDialogService;\n\n  fetchSubscription;\n\n  totalBrushTime = 10000;\n  timelineStepTime = 300;\n  allowedPlay = true;\n  allowHeatmap = false;\n  showHeatmap = false;\n\n  originTweet;\n  timelineData;\n  spreadMap;\n  timelinePlayData = [];\n  currentEvent;\n  currentEntity;\n  _debounceResize = _.debounce(this._reRender, DEBOUNC_TIME);\n  _attached = false;\n  resizing;\n  reseted;\n\n  constructor(element, eventAggregator, CbkitDialogService) {\n    this.element = element;\n    this.ea = eventAggregator;\n    this.cbkitDialogService = CbkitDialogService;\n    this.fetchSubscription = this.ea.subscribe('triggerFetch', () => {\n      this.timeline && this.timeline.resetTimeline();\n      this.timelinePlayData = [];\n      this.showPause = false;\n      this.allowedPlay = true\n      this.reseted = true;\n      this.allowHeatmap = false;\n      this.showHeatmap = false;\n    });\n  }\n\n  attached() {\n    this._attached = true;\n    this.mapContainer = d3.select(this.svgContainer).select('#tl-worldmap-countries');\n    this.linesContaner = d3.select(this.svgContainer).select('#tl-worldmap-lines');\n    this._renderMap();\n    new ResizeSensor(this.element, () => {\n      if (this.loading) {\n        return;\n      }\n      this.resizing = true;\n      this._debounceResize(this);\n    });\n    this._init();\n  }\n\n  detached() {\n    this._attached = false;\n    if (this.fetchSubscription) {\n      this.fetchSubscription.dispose();\n    }\n  }\n\n  dataChanged() {\n    setTimeout(() => {\n      this._init();\n    });\n  }\n  _init() {\n\n    if (!this._attached || !this.data) {\n      return;\n    }\n    this.originTweet = this.data.originTweet;\n    if (this.originTweet) {// just for demo to be deleted\n      this.originTweet.attributes.country_code_enrich = ['us'];\n    }\n    this.timelineData = [];\n    this.spreadMap = this.data.spreadMap;\n    if (this.data.timelineData && this.data.timelineData.length) {\n      const lastTimeDiff = this.data.timelineData[this.data.timelineData.length - 1].key;\n      const lastHourDiff = Math.ceil(lastTimeDiff / HOUR_TIMESPAN);\n      for (let i = 0; i <= lastHourDiff; i++) {\n        this.timelineData.push({ key: i + 'h', value: 0 });\n      }\n      this.data.timelineData.forEach(tlData => {\n        const hour = Math.ceil(tlData.key / HOUR_TIMESPAN);\n        let mappingHour = this.timelineData.find(d => {\n          return hour + 'h' == d.key;\n        })\n        if (mappingHour) {\n          mappingHour.value = mappingHour.value + tlData.value;\n        }\n      });\n\n      this.totalBrushTime = this._caculateBrushTime(lastHourDiff);\n      this._clearMap();\n      this._renderMap();\n      this._clearOriginLine();\n      this._clearSpreadLines();\n\n      setTimeout(() => {\n        this._renderOriginLine();\n      }, 500);\n    }\n  }\n  _reRender(self) {\n    this.resizing = false;\n    this._clearMap();\n    this._clearOriginLine();\n    this._clearSpreadLines();\n    this._renderMap();\n    if (!this.showHeatmap) {\n      this._renderOriginLine();\n      this.timelinePlayData.forEach((d, idx) => {\n        this._renderHourLines(idx, d.key);\n      });\n    } else {\n      this._renderHeatmap();\n    }\n  }\n\n  // render function\n  _renderMap() {\n    const $svgContainer = $(this.svgContainer);\n    let [width, height] = [$svgContainer.width(), $svgContainer.width() / 1.92];\n    $svgContainer.attr('height', height);\n    // width=1200;\n    // height=800;\n\n    /* Antarctica will not shown on the map */\n    var features = _.filter(worldMapData.features, function (value, key) {\n      return value.properties.name != 'Antarctica';\n    });\n\n    var projection = d3.geo.mercator();\n    var oldScala = projection.scale();\n    var oldTranslate = projection.translate();\n\n    this.xy = projection\n      .scale(oldScala * (width / oldTranslate[0] / 2))\n      // .scale(oldScala*2)\n      .translate([width / 2, height * 0.66]);\n\n    let path = d3.geo.path().projection(this.xy);\n\n    this.mapContainer.attr('width', width).attr('height', height);\n    this.mapContainer.selectAll('path').data(features).enter().append('svg:path')\n      .attr('country-code', data => data.CountryCode)\n      .attr('d', path)\n      .append('title')\n      .text((d) => d.CountryCode);\n  }\n  _renderOriginLine() {\n    if (!this._attached) {\n      return;\n    }\n    if (!(this.timelineData && this.timelineData.length)) {\n      return;\n    }\n    let tweet = this.originTweet;\n    const lineBaseTop = -20;\n    // get echart instance\n    let chart = this.timeline.echart.getChart();\n    // caculate the date`s postion(left) at the timeline\n    let lineBaseLeft = chart.convertToPixel({ xAxisIndex: 0 }, 0);\n    let startPosition = [lineBaseLeft, lineBaseTop];\n\n    let originTweetGeo = this._getTweetGeo(tweet);\n    if (originTweetGeo) {\n      let endPosition = this.xy(originTweetGeo);\n      const line = d3.svg.line().interpolate(\"linear\")\n        .x(data => data[0])\n        .y(data => data[1]);\n\n      this.linesContaner.append('svg:path')\n        .attr('d', line([startPosition, [startPosition[0], endPosition[1]], endPosition]))\n        .attr('class', 'origin')\n        .attr(\"marker-start\", \"url(#marker_arrow)\")\n        .attr(\"marker-end\", \"url(#arrow)\");\n\n      this._renderLocationPoint(tweet, endPosition, { r: 6, class: 'origin' });\n\n      this.linesContaner.append('svg:text')\n        .text(\"Tweeted\")\n        .attr('class', 'origin')\n        .attr('transform', 'translate(' + startPosition[0] + ', ' + (endPosition[1] + 18) + ')');\n    }\n\n  }\n  _renderHourLines(index, endTime, animate) {\n    if (!(this.timelineData && this.timelineData.length)) {\n      return;\n    }\n    const lineBaseTop = -46;\n    // get echart instance\n    const chart = this.timeline.echart.getChart();\n    // caculate the date`s postion(left) at the timeline\n    const lineBaseLeft = chart.convertToPixel({ xAxisIndex: 0 }, index);\n    const startPosition = [lineBaseLeft, lineBaseTop];\n\n    let spreadTweets = [];\n    this.spreadMap.forEach(tw => {\n      let time = (new Date(tw.event_time || tw.eventTime)).getTime();\n      let originTweetTime = (new Date(this.originTweet.event_time || tw.eventTime)).getTime();\n      let hour = Math.ceil((time - originTweetTime) / HOUR_TIMESPAN) + 'h';\n      if (hour == endTime) {\n        let location = this._getTweetGeo(tw);\n        if (location) {\n          spreadTweets.push({\n            tweet: tw,\n            hour: hour,\n            location: this._getTweetGeo(tw)\n          });\n        }\n      }\n    });\n\n    spreadTweets.forEach(tw => {\n      this._renderLine(startPosition, tw, animate)\n    });\n\n  }\n  _renderLine(startPosition, twInfo, animate) {\n    const line = d3.svg.line().interpolate(\"basis\")\n      .x(data => data[0])\n      .y(data => data[1]);\n    const endPosition = this.xy(twInfo.location);\n    let speadLine = this.linesContaner.append('svg:path')\n      .attr('d', line([startPosition, ...this._getSmoothPoint(startPosition, endPosition), endPosition]))\n      .attr('id', 'speadline-' + twInfo.tweet.id)\n      .attr('class', 'spread');\n    if (animate) {\n      let duration = speadLine.transition()\n        .duration(1000)\n        .attrTween(\"stroke-dasharray\", function () {\n          var len = this.getTotalLength();\n          return function (t) { return (d3.interpolateString(\"0,\" + len, len + \",0\"))(t) };\n        });\n      if (!this.resizing) {\n        duration.each('end', () => {\n          if (this.reseted) {\n            return;\n          }\n          this._renderLocationPoint(twInfo.tweet, endPosition);\n        });\n      }\n\n    } else {\n      this._renderLocationPoint(twInfo.tweet, endPosition);\n    }\n\n  }\n  _renderLocationPoint(tweet, position, options) {\n    options = _.assignIn({ r: 8, class: 'spread' }, options);\n    let circle = this.linesContaner\n      .append('circle')\n      .datum(tweet)\n      .attr('r', options.r)\n      .attr('id', 'speadcircle-' + tweet.id)\n      .attr('class', options.class)\n      .on('mouseover', () => {\n        this.linesContaner.select('#speadline-' + tweet.id).classed('active', true);\n        this.linesContaner.select('#speadcircle-' + tweet.id).classed('active', true);\n        this.currentEvent = tweet;\n        this.currentEntity = tweet.entities.from;\n        this._showEntityCard(position);\n      })\n      .on('mouseout', () => {\n        this.linesContaner.select('#speadline-' + tweet.id).classed('active', false);\n        this.linesContaner.select('#speadcircle-' + tweet.id).classed('active', false);\n        this._hideEntityCard();\n      })\n      .on('click', (tweet) => {\n        this.cbkitDialogService.openRecordDetail(tweet);\n      })\n      .attr('fill', 'rgba(73,144,226,0.6)')\n      .attr('transform', 'translate(' + position[0] + ', ' + position[1] + ')');\n    if (tweet.attributes.country_code_enrich && tweet.attributes.country_code_enrich[0]) {\n      let countryCode = tweet.attributes.country_code_enrich[0].toUpperCase();\n      let spreadCountryPath = this.mapContainer.select('[country-code=\"' + countryCode + '\"]');\n      spreadCountryPath.classed(options.class, true)\n    }\n  }\n  _renderHeatmap() {\n    if (this.data.eventsByCountryCode) {\n      let compute = d3.interpolate(d3.rgb('#83a8d8'), d3.rgb('#9ec5dd'));\n      let scaleDomain = this.data.eventsByCountryCode.map(d => d.value);\n      scaleDomain = _.sortedUniq(scaleDomain);\n      let colorRange = d3.scale.linear()\n        .domain([202, 1])\n        .range([0, 1]);\n      this.data.eventsByCountryCode.forEach(d => {\n        this.mapContainer.select('[country-code=\"' + d.key.toUpperCase() + '\"]')\n          .style('fill', compute(colorRange(d.value)))\n\n          .select('title')\n          .text(d.key.toUpperCase() + '\\n' + d.value);\n      });\n    }\n  }\n  _clearMap() {\n    this.mapContainer.selectAll('path').remove();\n  }\n  _clearOriginLine() {\n    this.linesContaner.selectAll('.origin').remove();\n  }\n  _clearSpreadLines() {\n    this.linesContaner.selectAll('.spread').remove();\n    this.mapContainer.selectAll('.spread').classed('spread', false);\n  }\n  _showEntityCard(position) {\n    let cardContainer = $(this.element).find('#tl-worldmap-entitycard');\n    let offsetParent = cardContainer.parent();\n    let left = position[0] + parseInt(offsetParent.css('paddingLeft'));\n    let top = position[1] + parseInt(offsetParent.css('paddingTop')) + 20;\n    const $svgContainer = $(this.svgContainer);\n    left = Math.min(left, $svgContainer.width() - 250);\n    cardContainer.removeClass('hide')\n      .css({ left: left, top: top });\n  }\n  _hideEntityCard() {\n    $(this.element).find('#tl-worldmap-entitycard').addClass('hide');\n  }\n  // private method\n  _getTweetGeo(tweet) {\n    let geo;\n    if (tweet.attributes.geo) {\n      geo = tweet.attributes.geo;\n    } else {\n      if (tweet.attributes.country_code_enrich && tweet.attributes.country_code_enrich[0]) {\n        let capitalInfo = countryCapitalLocation.find(cap => {\n          return cap.CountryCode == tweet.attributes.country_code_enrich[0].toUpperCase();\n        });\n        if (capitalInfo) {\n          geo = [capitalInfo.CapitalLongitude, capitalInfo.CapitalLatitude];\n        }\n      }\n    }\n    return geo;\n  }\n  _getSmoothPoint(startPoint, endPoint) {\n    const [x1, y1] = startPoint;\n    const [x2, y2] = endPoint;\n    return [\n      [x1 + (x2 - x1) / 12, y1 + (y2 - y1) * 5 / 12],\n      [x1 + (x2 - x1) * 4 / 12, y1 + (y2 - y1) * 9 / 12],\n      [x1 + (x2 - x1) * 8 / 12, y1 + (y2 - y1) * 11 / 12],\n    ];\n  }\n  _caculateBrushTime(count) {\n    const minTime = 1000;\n    return minTime + count * this.timelineStepTime;\n  }\n\n  // events\n  __toggleHeatmap() {\n    this._reRender();\n  }\n  __playBtnClicked() {\n    this.timeline.playTimeline();\n    this.showPause = true;\n    this.reseted = false;\n    this.allowHeatmap = false;\n  }\n  __pauseBtnClicked() {\n    this.timeline.pauseTimeline();\n    this.showPause = false;\n  }\n  __resetBtnClicked() {\n    this.timeline.resetTimeline();\n    this.timelinePlayData = [];\n    this.showPause = false;\n    this.allowedPlay = true\n    this.reseted = true;\n    this.allowHeatmap = false;\n    this.showHeatmap = false;\n    this._reRender();\n  }\n  __timelineBrush(d) {\n    this.timelinePlayData.push(d.endItem);\n    this._renderHourLines(d.endIndex, d.endItem.key, true);\n  }\n  __playDone(params) {\n    this.showPause = false;\n    this.allowedPlay = false;\n    this.allowHeatmap = true;\n  }\n\n}\n"]}